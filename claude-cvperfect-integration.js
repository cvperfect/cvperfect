/**
 * Claude <-> CVPerfect Integration Module
 * G≈Ç√≥wny punkt integracji Claude Code z systemem agent√≥w CVPerfect
 */

const { executeWithAgents, getSystemStatus } = require('./claude-task-delegator');
const { routeTask, getRouterStatus } = require('./claude-agent-router');
const path = require('path');
const fs = require('fs');

class ClaudeCVPerfectIntegration {
    constructor() {
        this.isInCVPerfectProject = this.detectCVPerfectProject();
        this.integrationActive = false;
        
        if (this.isInCVPerfectProject) {
            this.initializeIntegration();
        }
    }

    // Wykryj czy jeste≈õmy w projekcie CVPerfect
    detectCVPerfectProject() {
        const currentDir = process.cwd();
        const indicators = [
            'cvperfect',
            'CLAUDE.md',
            'start-agents-system.js',
            'package.json'
        ];

        // Sprawd≈∫ nazwƒô katalogu
        if (currentDir.toLowerCase().includes('cvperfect')) {
            return true;
        }

        // Sprawd≈∫ pliki charakterystyczne
        const hasIndicators = indicators.some(indicator => {
            const filePath = path.join(currentDir, indicator);
            return fs.existsSync(filePath);
        });

        // Sprawd≈∫ package.json
        const packageJsonPath = path.join(currentDir, 'package.json');
        if (fs.existsSync(packageJsonPath)) {
            try {
                const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
                if (packageJson.name && packageJson.name.toLowerCase().includes('cvperfect')) {
                    return true;
                }
            } catch (error) {
                // Ignore JSON parse errors
            }
        }

        return hasIndicators;
    }

    // Inicjalizuj integracjƒô
    initializeIntegration() {
        console.log('üîó Inicjalizujƒô integracjƒô Claude <-> CVPerfect...');
        
        try {
            // Sprawd≈∫ status systemu agent√≥w
            const status = getSystemStatus();
            
            if (status.active) {
                this.integrationActive = true;
                console.log('‚úÖ Integracja Claude <-> CVPerfect aktywna');
                console.log(`üìä Aktywne zadania: ${status.activeTasks.length}`);
                console.log(`üìö Historia zada≈Ñ: ${status.taskHistory.length}`);
            } else {
                console.log('‚ö†Ô∏è System agent√≥w CVPerfect nie jest aktywny');
                this.integrationActive = false;
            }
            
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd inicjalizacji integracji:', error);
            this.integrationActive = false;
        }
    }

    // G≈Ç√≥wna funkcja wykonania zadania przez agent√≥w
    async executeTask(taskDescription, options = {}) {
        if (!this.isInCVPerfectProject) {
            return {
                success: false,
                message: 'Nie jeste≈õmy w projekcie CVPerfect',
                useClaudeDirectly: true
            };
        }

        if (!this.integrationActive) {
            return {
                success: false,
                message: 'Integracja z agentami nie jest aktywna',
                useClaudeDirectly: true
            };
        }

        console.log(`\nüöÄ Wykonujƒô zadanie przez agent√≥w CVPerfect:`);
        console.log(`üìù "${taskDescription}"`);

        try {
            const result = await executeWithAgents(taskDescription, options);
            
            if (result.success) {
                console.log(`‚úÖ Zadanie wykonane przez agenta: ${result.agent}`);
                return result;
            } else if (result.fallback) {
                console.log(`üîÑ Przekazujƒô do Claude Code (fallback)`);
                return {
                    success: false,
                    message: result.message,
                    useClaudeDirectly: true
                };
            } else {
                return result;
            }
            
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd wykonania zadania przez agent√≥w:', error);
            return {
                success: false,
                message: error.message,
                useClaudeDirectly: true
            };
        }
    }

    // Nowa funkcja do obs≈Çugi skr√≥tu -sa
    async handleSubagentRequest(taskDescription, options = {}) {
        console.log(`\nüéØ Obs≈Çuga skr√≥tu -sa dla zadania: "${taskDescription}"`);
        
        try {
            // U≈ºyj nowego routera do inteligentnego delegowania
            const result = await routeTask(taskDescription, options);
            
            if (result.useFallback) {
                // Router zdecydowa≈Ç o fallback do Task tool Claude
                console.log(`üîÑ Router zaleca u≈ºycie Task tool Claude`);
                return {
                    success: true,
                    useTaskTool: true,
                    taskToolParams: result.taskTool,
                    message: result.message,
                    source: 'claude-agent-router-fallback'
                };
            } else if (result.success) {
                // Zadanie zosta≈Ço pomy≈õlnie przekazane do agent√≥w CVPerfect
                console.log(`‚úÖ Zadanie przekazane do agenta: ${result.agent}`);
                return {
                    success: true,
                    useTaskTool: false,
                    agent: result.agent,
                    result: result.result,
                    source: 'cvperfect-agents'
                };
            } else {
                // B≈ÇƒÖd w systemie routingu
                return {
                    success: false,
                    message: `B≈ÇƒÖd routingu: ${result.message}`,
                    useClaudeDirectly: true
                };
            }
            
        } catch (error) {
            console.error('‚ùå B≈ÇƒÖd obs≈Çugi skr√≥tu -sa:', error);
            return {
                success: false,
                message: error.message,
                useClaudeDirectly: true
            };
        }
    }

    // Sprawd≈∫ czy zadanie powinno byƒá wykonane przez agent√≥w
    shouldUseAgents(taskDescription) {
        if (!this.isInCVPerfectProject || !this.integrationActive) {
            return false;
        }

        const task = taskDescription.toLowerCase();
        
        // Zadania typowe dla CVPerfect
        const cvperfectTasks = [
            // Frontend
            'react', 'component', 'jsx', 'css', 'styling', 'responsive', 'ui', 'ux',
            
            // Backend/API
            'api', 'endpoint', 'server', 'database', 'stripe', 'payment', 'groq',
            
            // CVPerfect specific
            'cv', 'resume', 'template', 'ats', 'optimization', 'szablon', 'optymalizacja',
            
            // Maintenance
            'bug', 'b≈ÇƒÖd', 'fix', 'napraw', 'optimize', 'optymizuj', 'test', 'testuj',
            'refactor', 'refaktoryzuj', 'analyze', 'analizuj', 'check', 'sprawd≈∫',
            
            // Security & Performance
            'security', 'bezpiecze≈Ñstwo', 'performance', 'wydajno≈õƒá', 'gdpr',
            
            // Business
            'analytics', 'marketing', 'seo', 'language', 'jƒôzyk', 'polish', 'polski'
        ];

        return cvperfectTasks.some(keyword => task.includes(keyword));
    }

    // Pobierz status integracji
    getIntegrationStatus() {
        const routerStatus = getRouterStatus();
        
        return {
            inCVPerfectProject: this.isInCVPerfectProject,
            integrationActive: this.integrationActive,
            systemStatus: this.integrationActive ? getSystemStatus() : null,
            routerStatus: routerStatus,
            subagentShortcutReady: this.isInCVPerfectProject && routerStatus.router === 'active'
        };
    }

    // Sprawd≈∫ czy integracja jest aktywna
    isActive() {
        return this.isInCVPerfectProject && this.integrationActive;
    }
}

// Singleton instance
let integrationInstance = null;

function getIntegration() {
    if (!integrationInstance) {
        integrationInstance = new ClaudeCVPerfectIntegration();
    }
    return integrationInstance;
}

// Export g≈Ç√≥wnych funkcji
module.exports = {
    ClaudeCVPerfectIntegration,
    getIntegration,
    
    // G≈Ç√≥wna funkcja dla Claude Code
    async processTask(taskDescription, options = {}) {
        const integration = getIntegration();
        
        if (integration.shouldUseAgents(taskDescription)) {
            const result = await integration.executeTask(taskDescription, options);
            
            if (result.useClaudeDirectly) {
                return {
                    useAgents: false,
                    message: 'U≈ºywaj standardowych narzƒôdzi Claude Code',
                    reason: result.message
                };
            } else {
                return {
                    useAgents: true,
                    success: result.success,
                    result: result.result || result.message,
                    agent: result.agent,
                    taskId: result.taskId
                };
            }
        } else {
            return {
                useAgents: false,
                message: 'Zadanie nie wymaga u≈ºycia agent√≥w CVPerfect'
            };
        }
    },

    // Nowa funkcja dla obs≈Çugi skr√≥tu -sa
    async handleSubagentShortcut(taskDescription, options = {}) {
        const integration = getIntegration();
        return await integration.handleSubagentRequest(taskDescription, options);
    },
    
    // Status integracji
    getStatus() {
        const integration = getIntegration();
        return integration.getIntegrationStatus();
    },
    
    // Sprawd≈∫ czy jeste≈õmy w CVPerfect
    isInCVPerfect() {
        const integration = getIntegration();
        return integration.isInCVPerfectProject;
    }
};

// Auto-test przy uruchomieniu
if (require.main === module) {
    const integration = new ClaudeCVPerfectIntegration();
    console.log('üîó Claude <-> CVPerfect Integration ready');
    console.log(`üìÇ In CVPerfect project: ${integration.isInCVPerfectProject}`);
    console.log(`‚ö° Integration active: ${integration.integrationActive}`);
    
    if (integration.isActive()) {
        console.log('üéØ Gotowy do delegowania zada≈Ñ do agent√≥w CVPerfect');
    }
}